<script>
firebase.initializeApp({
  apiKey: "AIzaSyCqc07_iFk565ATUXfH0WN9X592-BpN454",
  authDomain: "barber-shop-4c26f.firebaseapp.com",
  projectId: "barber-shop-4c26f"
});
const db = firebase.firestore();

/* ADD CUSTOMER */
async function addCustomer() {
  const name = document.getElementById("name").value.trim();
  const principal = +document.getElementById("principal").value;
  const rate = +document.getElementById("rate").value;
  const month = document.getElementById("month").value;

  if (!name || !principal || !rate || !month) {
    alert("Fill all fields & select month");
    return;
  }

  const ref = await db.collection("customers").add({ name, rate });

  await ref.collection("ledger").doc(month).set({
    principal,
    collected: 0,
    interest: principal * rate / 100,
    created: firebase.firestore.Timestamp.now()
  });

  document.getElementById("name").value = "";
  document.getElementById("principal").value = "";
  document.getElementById("rate").value = "";

  loadData();
}

/* LOAD MONTH DATA */
async function loadData() {
  const month = document.getElementById("month").value;
  if (!month) return;

  const tbody = document.getElementById("list");
  const totals = document.getElementById("totals");
  tbody.innerHTML = "";
  totals.innerHTML = "";

  let totalP = 0, totalI = 0;

  const customers = await db.collection("customers").get();

  for (const doc of customers.docs) {
    const cust = doc.data();
    const ledgerRef = doc.ref.collection("ledger");
    let record = await ledgerRef.doc(month).get();

    // ðŸ”‘ AUTO CREATE MONTH IF NOT EXISTS
    if (!record.exists) {
      const prevMonth = getPreviousMonth(month);
      const prevRec = await ledgerRef.doc(prevMonth).get();

      if (!prevRec.exists) continue; // first month not created yet

      const p = prevRec.data();
      const newPrincipal = Math.max(p.principal - (p.collected || 0), 0);
      const newInterest = newPrincipal * cust.rate / 100;

      await ledgerRef.doc(month).set({
        principal: newPrincipal,
        collected: 0,
        interest: newInterest,
        created: firebase.firestore.Timestamp.now()
      });

      record = await ledgerRef.doc(month).get();
    }

    const r = record.data();
    totalP += r.principal;
    totalI += r.interest;

    tbody.innerHTML += `
      <tr>
        <td>${cust.name}</td>
        <td>â‚¹${r.principal}</td>
        <td>
          <input class="num-input" type="number"
            value="${r.collected}"
            onchange="updateCollected('${doc.id}','${month}',this.value)">
        </td>
        <td>â‚¹${r.interest}</td>
      </tr>
    `;
  }

  totals.innerHTML =
    `Total Principal: â‚¹${totalP}<br>Total Interest: â‚¹${totalI}`;
}

/* UPDATE COLLECTION ONLY */
function updateCollected(cid, month, value) {
  db.collection("customers").doc(cid)
    .collection("ledger").doc(month)
    .update({ collected: +value });
}

/* GET PREVIOUS MONTH */
function getPreviousMonth(month) {
  const [y, m] = month.split("-").map(Number);
  const d = new Date(y, m - 1);
  d.setMonth(d.getMonth() - 1);
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
}
</script>
