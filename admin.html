<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Customer Ledger</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f2f4f7;padding:10px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px}
input,button{width:100%;padding:6px}
button{background:#007bff;color:#fff;border:none;border-radius:6px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#eee}
.total{font-weight:bold;background:#e8f4ff}
.small{font-size:13px;color:#555}
</style>
</head>

<body>

<h2>Customer Ledger</h2>

<div class="card">
<h3>Add Customer</h3>
<input id="cname" placeholder="Customer Name">
<input id="phone" placeholder="Phone">
<button onclick="addCustomer()">Add</button>
</div>

<div class="card">
<h3>Select Month</h3>
<input type="month" id="month" onchange="loadData()">
<div class="small">Interest fixed at 3%</div>
</div>

<div class="card">
<h3>Ledger</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Phone</th>
<th>Principal</th>
<th>Collected</th>
<th>Interest</th>
<th>Save</th>
</tr>
</thead>
<tbody id="rows"></tbody>
<tfoot>
<tr class="total">
<td colspan="2">TOTAL</td>
<td id="tp">0</td>
<td>-</td>
<td id="ti">0</td>
<td></td>
</tr>
</tfoot>
</table>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCqc07_iFk565ATUXfH0WN9X592-BpN454",
  authDomain: "barber-shop-4c26f.firebaseapp.com",
  projectId: "barber-shop-4c26f"
});

const db = firebase.firestore();
const RATE = 3;

month.value = new Date().toISOString().slice(0,7);

function addCustomer(){
  if(!cname.value || !phone.value) return alert("Fill all");
  db.collection("customers").add({
    name:cname.value,
    phone:phone.value
  }).then(()=>{
    cname.value="";
    phone.value="";
    loadData();
  });
}

function prevMonth(m){
  const d = new Date(m + "-01");
  d.setMonth(d.getMonth() - 1);
  return d.toISOString().slice(0,7);
}

function calcInterest(cid){
  const p = Number(document.getElementById("p_"+cid).value || 0);
  document.getElementById("i_"+cid).value = (p * RATE / 100).toFixed(2);
}

async function loadData(){
  const m = month.value;
  if(!m) return;

  rows.innerHTML="";
  let tp=0, ti=0;

  const customers = await db.collection("customers").get();

  for(const c of customers.docs){
    const cust = c.data();

    // check current month
    const curSnap = await db.collection("monthly_ledger")
      .where("customerId","==",c.id)
      .where("month","==",m)
      .get();

    let principal=0, collected=0, interest=0, docId="";

    if(!curSnap.empty){
      const d = curSnap.docs[0];
      docId = d.id;
      principal = d.data().principal;
      collected = d.data().collected;
      interest = d.data().interest;
    } else {
      // load previous month
      const pm = prevMonth(m);
      const prevSnap = await db.collection("monthly_ledger")
        .where("customerId","==",c.id)
        .where("month","==",pm)
        .get();

      if(!prevSnap.empty){
        const p = prevSnap.docs[0].data();
        principal = p.principal - p.collected;
        interest = (principal * RATE / 100).toFixed(2);
      }
    }

    tp += Number(principal);
    ti += Number(interest);

    rows.innerHTML += `
    <tr>
      <td>${cust.name}</td>
      <td>${cust.phone}</td>
      <td>
        <input id="p_${c.id}" type="number"
          value="${principal}"
          oninput="calcInterest('${c.id}')">
      </td>
      <td>
        <input id="c_${c.id}" type="number" value="${collected}">
      </td>
      <td>
        <input id="i_${c.id}" value="${interest}" readonly>
      </td>
      <td>
        <button onclick="save('${c.id}','${docId}')">Save</button>
      </td>
    </tr>`;
  }

  tpElem.textContent = tp.toFixed(2);
  tiElem.textContent = ti.toFixed(2);
}

async function save(cid,docId){
  const p = Number(document.getElementById("p_"+cid).value||0);
  const c = Number(document.getElementById("c_"+cid).value||0);
  const i = Number(document.getElementById("i_"+cid).value||0);

  const obj = {
    customerId: cid,
    month: month.value,
    principal: p,
    collected: c,
    interest: i
  };

  if(docId)
    await db.collection("monthly_ledger").doc(docId).set(obj);
  else
    await db.collection("monthly_ledger").add(obj);

  loadData();
}

loadData();
</script>

</body>
</html>
