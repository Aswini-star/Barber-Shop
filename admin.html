<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin – Customers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f2f4f7;
  margin:0;
  padding:10px;
}
h2 { text-align:center; }

.card {
  background:#fff;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  margin-bottom:15px;
}

input, select, button {
  width:100%;
  padding:8px;
  margin-top:8px;
  font-size:15px;
}

input[type=number] { max-width:100%; }

button {
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:6px;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}
th, td {
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th { background:#f0f0f0; }

.total {
  font-weight:bold;
  background:#e8f4ff;
}
</style>
</head>

<body>

<h2>Admin – Customer Ledger</h2>

<div class="card">
<h3>Add Customer</h3>
<input id="name" placeholder="Customer Name">
<input id="phone" placeholder="Phone Number">
<input id="principal" type="number" max="100000" placeholder="Principal (max 1,00,000)">
<button onclick="addCustomer()">Add Customer</button>
</div>

<div class="card">
<h3>Select Month</h3>
<input type="month" id="monthPicker" onchange="loadData()">
</div>

<div class="card">
<h3>Customers</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Phone</th>
<th>Principal</th>
<th>Collected</th>
<th>Interest</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
<tfoot>
<tr class="total">
<td colspan="2">TOTAL</td>
<td id="tPrincipal">0</td>
<td>-</td>
<td id="tInterest">0</td>
</tr>
</tfoot>
</table>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCqc07_iFk565ATUXfH0WN9X592-BpN454",
  authDomain: "barber-shop-4c26f.firebaseapp.com",
  projectId: "barber-shop-4c26f"
});

const db = firebase.firestore();
const FIXED_RATE = 3; // monthly %

document.getElementById("monthPicker").value =
  new Date().toISOString().slice(0,7);

function addCustomer() {
  const name = name.value.trim();
  const phone = phone.value.trim();
  const principal = Number(principal.value);

  if(!name || !phone || !principal){
    alert("Fill all fields");
    return;
  }

  db.collection("customers").add({
    name, phone,
    created: firebase.firestore.Timestamp.now()
  }).then(() => {
    name.value=""; phone.value=""; principal.value="";
    loadData();
  });
}

async function loadData() {
  const month = monthPicker.value;
  if(!month) return;

  const start = new Date(month+"-01");
  const end = new Date(start);
  end.setMonth(end.getMonth()+1);

  const body = document.getElementById("tbody");
  body.innerHTML="";
  let tP=0, tI=0;

  const customers = await db.collection("customers").get();

  for(const c of customers.docs){
    const cust = c.data();
    const ledgerRef = db.collection("ledger");

    let prev = await ledgerRef
      .where("cid","==",c.id)
      .where("month","<",month)
      .orderBy("month","desc")
      .limit(1)
      .get();

    let principalAmt = prev.empty ? 0 :
      prev.docs[0].data().principal -
      prev.docs[0].data().collected;

    if(prev.empty){
      principalAmt = await askInitialPrincipal(c.id);
    }

    let cur = await ledgerRef
      .where("cid","==",c.id)
      .where("month","==",month)
      .get();

    let collected=0, interest=0;

    if(cur.empty){
      interest = Math.round(principalAmt * FIXED_RATE / 100);
      await ledgerRef.add({
        cid:c.id,
        month,
        principal:principalAmt,
        collected:0,
        interest
      });
    } else {
      collected = cur.docs[0].data().collected;
      interest = cur.docs[0].data().interest;
    }

    tP += principalAmt;
    tI += interest;

    body.innerHTML += `
    <tr>
      <td>${cust.name}</td>
      <td>${cust.phone}</td>
      <td>${principalAmt}</td>
      <td>
        <input type="number" value="${collected}"
        onchange="updateCollected('${cur.empty?'':cur.docs[0].id}',this.value)">
      </td>
      <td>${interest}</td>
    </tr>`;
  }

  tPrincipal.innerText = tP;
  tInterest.innerText = tI;
}

async function askInitialPrincipal(cid){
  const p = prompt("Enter initial principal:");
  if(!p) return 0;
  await db.collection("ledger").add({
    cid,
    month:monthPicker.value,
    principal:Number(p),
    collected:0,
    interest:Math.round(p*FIXED_RATE/100)
  });
  return Number(p);
}

function updateCollected(id,val){
  if(!id) return;
  db.collection("ledger").doc(id).update({
    collected:Number(val)
  });
}

loadData();
</script>

</body>
</html>
