<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin – Monthly Ledger</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f7;
  padding: 10px;
}
h2 { text-align:center; }

.card {
  background:#fff;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}

input, select, button {
  width:100%;
  padding:10px;
  margin-top:8px;
  font-size:16px;
}

button { background:#007bff;color:#fff;border:none;border-radius:6px; }
button.danger { background:#dc3545; }

table { width:100%; border-collapse:collapse; min-width:720px; }
th, td { padding:8px; border-bottom:1px solid #ddd; font-size:14px; }
th { background:#f1f1f1; }

.num-input { width:90px; }
.total { font-weight:bold; text-align:right; margin-top:10px; }
</style>
</head>

<body>

<h2>Monthly Customer Ledger</h2>

<!-- MONTH -->
<div class="card">
  <h3>Select Month</h3>
  <select id="monthSelect" onchange="loadCustomers()">
    <option value="">Select</option>
    <option value="2025-01">Jan 2025</option>
    <option value="2025-02">Feb 2025</option>
    <option value="2025-03">Mar 2025</option>
    <option value="2025-04">Apr 2025</option>
  </select>
</div>

<!-- ADD CUSTOMER -->
<div class="card">
  <h3>Add Customer</h3>
  <input id="name" placeholder="Customer Name">
  <input id="principal" type="number" max="100000" placeholder="Opening Principal">
  <input id="rate" type="number" placeholder="Monthly Interest % (Fixed)">
  <button onclick="addCustomer()">Add</button>
</div>

<!-- TABLE -->
<div class="card">
<h3>Records</h3>
<div style="overflow-x:auto">
<table>
<thead>
<tr>
  <th>Name</th>
  <th>Principal</th>
  <th>Collected</th>
  <th>Interest</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>
<div class="total" id="totals"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCqc07_iFk565ATUXfH0WN9X592-BpN454",
  authDomain: "barber-shop-4c26f.firebaseapp.com",
  projectId: "barber-shop-4c26f"
});
const db = firebase.firestore();

/* ADD CUSTOMER */
async function addCustomer() {
  const name = nameInput.value.trim();
  const principal = +principalInput.value;
  const rate = +rateInput.value;
  const month = monthSelect.value;

  if (!name || !principal || !rate || !month) {
    alert("Fill all fields & select month");
    return;
  }

  const ref = await db.collection("customers").add({ name, rate });

  await ref.collection("records").doc(month).set({
    principal,
    collected: 0,
    interest: principal * rate / 100,
    created: firebase.firestore.Timestamp.now()
  });

  nameInput.value = principalInput.value = rateInput.value = "";
  loadCustomers();
}

/* LOAD MONTH DATA */
async function loadCustomers() {
  const month = monthSelect.value;
  if (!month) return;

  const tbody = list;
  tbody.innerHTML = "";
  let totalP = 0, totalI = 0;

  const snap = await db.collection("customers").get();
  for (const doc of snap.docs) {
    const c = doc.data();
    const rec = await doc.ref.collection("records").doc(month).get();
    if (!rec.exists) continue;

    const r = rec.data();
    totalP += r.principal;
    totalI += r.interest;

    tbody.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>₹${r.principal}</td>
        <td>
          <input class="num-input" type="number"
            value="${r.collected}"
            onchange="updateCollected('${doc.id}','${month}',this.value)">
        </td>
        <td>₹${r.interest}</td>
        <td>
          <button class="danger" onclick="remove('${doc.id}')">Delete</button>
        </td>
      </tr>`;
  }

  totals.innerHTML =
    `Total Principal: ₹${totalP}<br>Total Interest: ₹${totalI}`;
}

/* SAVE COLLECTION */
function updateCollected(cid, month, val) {
  db.collection("customers").doc(cid)
    .collection("records").doc(month)
    .update({ collected:+val });
}

/* DELETE CUSTOMER */
function remove(id) {
  if(confirm("Delete customer?"))
    db.collection("customers").doc(id).delete().then(loadCustomers);
}
</script>

</body>
</html>
