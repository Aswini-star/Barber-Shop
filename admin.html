<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin â€“ Monthly Ledger</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f2f4f7; padding:10px }
.card { background:#fff; padding:15px; margin-bottom:15px; border-radius:10px }
input,select,button { width:100%; padding:10px; margin-top:8px }
button { background:#007bff; color:#fff; border:none; border-radius:6px }
table { width:100%; border-collapse:collapse }
th,td { padding:8px; border-bottom:1px solid #ddd }
</style>
</head>

<body>

<h2>Monthly Customer Ledger</h2>

<div class="card">
  <h3>Add Customer</h3>
  <input id="name" placeholder="Customer Name">
  <input id="principal" type="number" placeholder="Opening Principal">
  <input id="rate" type="number" placeholder="Monthly Interest %">
  <button onclick="addCustomer()">Add</button>
</div>

<div class="card">
  <h3>Select Month</h3>
  <select id="month"></select>
  <button onclick="loadData()">Load</button>
</div>

<div class="card">
  <table>
    <thead>
      <tr><th>Name</th><th>Principal</th><th>Collected</th><th>Interest</th></tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCqc07_iFk565ATUXfH0WN9X592-BpN454",
  authDomain: "barber-shop-4c26f.firebaseapp.com",
  projectId: "barber-shop-4c26f"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ðŸ”‘ AUTH FIX (THIS WAS MISSING) */
auth.signInAnonymously()
  .then(()=>console.log("Auth OK"))
  .catch(e=>alert(e.message));

function currentMonth(){
  const d=new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
}

/* MONTH LIST */
const sel=document.getElementById("month");
for(let y=2024;y<=2035;y++){
  for(let m=0;m<12;m++){
    const v=`${y}-${String(m+1).padStart(2,"0")}`;
    sel.innerHTML+=`<option value="${v}">${v}</option>`;
  }
}
sel.value=currentMonth();

/* ADD CUSTOMER */
async function addCustomer(){
  const name=nameEl.value.trim();
  const principal=+principalEl.value;
  const rate=+rateEl.value;

  if(!name||!principal||!rate){ alert("Fill all"); return; }

  const ref=await db.collection("customers").add({name,rate});
  await ref.collection("ledger").doc(currentMonth()).set({
    principal, collected:0, interest:principal*rate/100
  });

  loadData();
}

async function loadData(){
  const m=sel.value;
  list.innerHTML="";
  const snap=await db.collection("customers").get();

  for(const d of snap.docs){
    const l=await d.ref.collection("ledger").doc(m).get();
    if(!l.exists) continue;
    const r=l.data();
    list.innerHTML+=`
      <tr>
        <td>${d.data().name}</td>
        <td>${r.principal}</td>
        <td><input value="${r.collected}"
          onchange="d.ref.collection('ledger').doc('${m}')
          .update({collected:+this.value})"></td>
        <td>${r.interest}</td>
      </tr>`;
  }
}

/* shortcuts */
const nameEl=name, principalEl=principal, rateEl=rate, list=list;
</script>

</body>
</html>
