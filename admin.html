<script>
firebase.initializeApp({
  apiKey: "AIzaSyCqc07_iFk565ATUXfH0WN9X592-BpN454",
  authDomain: "barber-shop-4c26f.firebaseapp.com",
  projectId: "barber-shop-4c26f"
});
const db = firebase.firestore();

/* ADD CUSTOMER */
async function addCustomer() {
  const name = nameInput.value.trim();
  const principal = +principalInput.value;
  const rate = +rateInput.value;
  const month = monthSelect.value;

  if (!name || !principal || !rate || !month) {
    alert("Fill all fields");
    return;
  }

  const ref = await db.collection("customers").add({ name, rate });

  await ref.collection("ledger").doc(month).set({
    principal,
    collected: 0,
    interest: principal * rate / 100,
    closed: false,
    created: firebase.firestore.Timestamp.now()
  });

  loadData();
}

/* LOAD MONTH (READ ONLY) */
async function loadData() {
  const month = monthSelect.value;
  if (!month) return;

  list.innerHTML = "";
  totals.innerHTML = "";

  let tp = 0, ti = 0;
  const snap = await db.collection("customers").get();

  for (const doc of snap.docs) {
    const c = doc.data();
    const rec = await doc.ref.collection("ledger").doc(month).get();
    if (!rec.exists) continue;

    const r = rec.data();
    tp += r.principal;
    ti += r.interest;

    list.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>â‚¹${r.principal}</td>
        <td>
          <input class="num-input"
            type="number"
            value="${r.collected}"
            ${r.closed ? "disabled" : ""}
            onchange="saveCollected('${doc.id}','${month}',this.value)">
        </td>
        <td>â‚¹${r.interest}</td>
      </tr>`;
  }

  totals.innerHTML = `Total Principal â‚¹${tp}<br>Total Interest â‚¹${ti}`;
}

/* SAVE COLLECTION (CURRENT MONTH ONLY) */
function saveCollected(id, month, val) {
  db.collection("customers").doc(id)
    .collection("ledger").doc(month)
    .update({ collected: +val });
}

/* ðŸ”’ CLOSE MONTH (THIS IS THE FIX) */
async function closeMonth() {
  const month = monthSelect.value;
  if (!month) return;

  const next = nextMonth(month);
  const customers = await db.collection("customers").get();

  for (const doc of customers.docs) {
    const ref = doc.ref.collection("ledger");
    const cur = await ref.doc(month).get();
    if (!cur.exists || cur.data().closed) continue;

    const r = cur.data();
    const newPrincipal = Math.max(r.principal - r.collected, 0);
    const rate = (await doc.ref.get()).data().rate;

    await ref.doc(month).update({ closed: true });

    await ref.doc(next).set({
      principal: newPrincipal,
      collected: 0,
      interest: newPrincipal * rate / 100,
      closed: false,
      created: firebase.firestore.Timestamp.now()
    });
  }

  monthSelect.value = next;
  loadData();
}

/* NEXT MONTH HELPER */
function nextMonth(m) {
  const [y, mo] = m.split("-").map(Number);
  const d = new Date(y, mo);
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
}
</script>
